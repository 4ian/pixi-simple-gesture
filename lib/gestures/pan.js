'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = panable;
function panable(sprite, inertia) {

  function mouseDown(e) {
    start(e.data.originalEvent);
  }

  function touchStart(e) {
    if (e.data.originalEvent.targetTouches && e.data.originalEvent.targetTouches[0]) {
      start(e.data.originalEvent.targetTouches[0]);
    }
  }

  function start(t) {
    if (sprite._pan) {
      if (!sprite._pan.intervalId) {
        return;
      }
      clearInterval(sprite._pan.intervalId);
      sprite.emit('panend');
    }
    sprite._pan = {
      p: {
        x: t.clientX,
        y: t.clientY,
        date: new Date()
      }
    };
    sprite.on('mousemove', mouseMove).on('touchmove', touchMove);
  }

  function mouseMove(e) {
    move(e, e.data.originalEvent);
  }

  function touchMove(e) {
    var t = e.data.originalEvent.targetTouches;
    if (!t || t.length > 1) {
      end(e, t[0]);
      return;
    }
    move(e, t[0]);
  }

  function move(e, t) {
    var now = new Date();
    var interval = now - sprite._pan.p.date;
    if (interval < 12) {
      return;
    }
    var dx = t.clientX - sprite._pan.p.x;
    var dy = t.clientY - sprite._pan.p.y;
    var distance = Math.sqrt(dx * dx + dy * dy);
    if (!sprite._pan.pp) {
      var threshold = t instanceof window.MouseEvent ? 2 : 7;
      if (distance > threshold) {
        sprite.emit('panstart');
      } else {
        return;
      }
    } else {
      var event = {
        deltaX: dx,
        deltaY: dy,
        velocity: distance / interval,
        data: e.data
      };
      sprite.emit('panmove', event);
    }
    sprite._pan.pp = {
      x: sprite._pan.p.x,
      y: sprite._pan.p.y,
      date: sprite._pan.p.date
    };
    sprite._pan.p = {
      x: t.clientX,
      y: t.clientY,
      date: now
    };
  }

  function mouseUp(e) {
    end(e, e.data.originalEvent);
  }

  function touchEnd(e) {
    end(e, e.data.originalEvent.changedTouches && e.data.originalEvent.changedTouches[0]);
  }

  function end(e, t) {
    sprite.removeListener('mousemove', mouseMove).removeListener('touchmove', touchMove);
    if (!sprite._pan || !sprite._pan.pp) {
      sprite._pan = null;
      return;
    }
    if (inertia && t) {
      if (sprite._pan.intervalId) {
        return;
      }
      var interval = new Date() - sprite._pan.pp.date;
      var vx = (t.clientX - sprite._pan.pp.x) / interval;
      var vy = (t.clientY - sprite._pan.pp.y) / interval;
      sprite._pan.intervalId = setInterval(function () {
        if (Math.abs(vx) < 0.04 && Math.abs(vy) < 0.04) {
          clearInterval(sprite._pan.intervalId);
          sprite.emit('panend');
          sprite._pan = null;
          return;
        }
        var touch = {
          clientX: sprite._pan.p.x + vx * 12,
          clientY: sprite._pan.p.y + vy * 12
        };
        move(e, touch);
        vx *= 0.9;
        vy *= 0.9;
      }, 12);
    } else {
      sprite.emit('panend');
      sprite._pan = null;
    }
  }

  sprite.interactive = true;
  sprite.on('mousedown', mouseDown).on('touchstart', touchStart).on('mouseup', mouseUp).on('mouseupoutside', mouseUp).on('touchend', touchEnd).on('touchendoutside', touchEnd);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9nZXN0dXJlcy9wYW4uanMiXSwibmFtZXMiOlsicGFuYWJsZSIsInNwcml0ZSIsImluZXJ0aWEiLCJtb3VzZURvd24iLCJlIiwic3RhcnQiLCJkYXRhIiwib3JpZ2luYWxFdmVudCIsInRvdWNoU3RhcnQiLCJ0YXJnZXRUb3VjaGVzIiwidCIsIl9wYW4iLCJpbnRlcnZhbElkIiwiY2xlYXJJbnRlcnZhbCIsImVtaXQiLCJwIiwieCIsImNsaWVudFgiLCJ5IiwiY2xpZW50WSIsImRhdGUiLCJEYXRlIiwib24iLCJtb3VzZU1vdmUiLCJ0b3VjaE1vdmUiLCJtb3ZlIiwibGVuZ3RoIiwiZW5kIiwibm93IiwiaW50ZXJ2YWwiLCJkeCIsImR5IiwiZGlzdGFuY2UiLCJNYXRoIiwic3FydCIsInBwIiwidGhyZXNob2xkIiwid2luZG93IiwiTW91c2VFdmVudCIsImV2ZW50IiwiZGVsdGFYIiwiZGVsdGFZIiwidmVsb2NpdHkiLCJtb3VzZVVwIiwidG91Y2hFbmQiLCJjaGFuZ2VkVG91Y2hlcyIsInJlbW92ZUxpc3RlbmVyIiwidngiLCJ2eSIsInNldEludGVydmFsIiwiYWJzIiwidG91Y2giLCJpbnRlcmFjdGl2ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7a0JBQXdCQSxPO0FBQVQsU0FBU0EsT0FBVCxDQUFrQkMsTUFBbEIsRUFBMEJDLE9BQTFCLEVBQW1DOztBQUVoRCxXQUFTQyxTQUFULENBQW9CQyxDQUFwQixFQUF1QjtBQUNyQkMsVUFBTUQsRUFBRUUsSUFBRixDQUFPQyxhQUFiO0FBQ0Q7O0FBRUQsV0FBU0MsVUFBVCxDQUFxQkosQ0FBckIsRUFBd0I7QUFDdEIsUUFBSUEsRUFBRUUsSUFBRixDQUFPQyxhQUFQLENBQXFCRSxhQUFyQixJQUFzQ0wsRUFBRUUsSUFBRixDQUFPQyxhQUFQLENBQXFCRSxhQUFyQixDQUFtQyxDQUFuQyxDQUExQyxFQUFpRjtBQUMvRUosWUFBTUQsRUFBRUUsSUFBRixDQUFPQyxhQUFQLENBQXFCRSxhQUFyQixDQUFt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QmQsS0FBS2lCLEdBQUwsQ0FBU0YsRUFBVCxJQUFlLElBQTFDLEVBQWdEO0FBQzlDbkMsd0JBQWNaLE9BQU9VLElBQVAsQ0FBWUMsVUFBMUI7QUFDQVgsaUJBQU9hLElBQVAsQ0FBWSxRQUFaO0FBQ0FiLGlCQUFPVSxJQUFQLEdBQWMsSUFBZDtBQUNBO0FBQ0Q7QUFDRCxZQUFJd0MsUUFBUTtBQUNWbEMsbUJBQVNoQixPQUFPVSxJQUFQLENBQVlJLENBQVosQ0FBY0MsQ0FBZCxHQUFrQitCLEtBQUssRUFEdEI7QUFFVjVCLG1CQUFTbEIsT0FBT1UsSUFBUCxDQUFZSSxDQUFaLENBQWNHLENBQWQsR0FBa0I4QixLQUFLO0FBRnRCLFNBQVo7QUFJQXZCLGFBQUtyQixDQUFMLEVBQVErQyxLQUFSO0FBQ0FKLGNBQU0sR0FBTjtBQUNBQyxjQUFNLEdBQU47QUFDRCxPQWR3QixFQWN0QixFQWRzQixDQUF6QjtBQWVELEtBdEJELE1Bc0JPO0FBQ0wvQyxhQUFPYSxJQUFQLENBQVksUUFBWjtBQUNBYixhQUFPVSxJQUFQLEdBQWMsSUFBZDtBQUNEO0FBQ0Y7O0FBRURWLFNBQU9tRCxXQUFQLEdBQXFCLElBQXJCO0FBQ0FuRCxTQUNHcUIsRUFESCxDQUNNLFdBRE4sRUFDbUJuQixTQURuQixFQUVHbUIsRUFGSCxDQUVNLFlBRk4sRUFFb0JkLFVBRnBCLEVBR0djLEVBSEgsQ0FHTSxTQUhOLEVBR2lCcUIsT0FIakIsRUFJR3JCLEVBSkgsQ0FJTSxnQkFKTixFQUl3QnFCLE9BSnhCLEVBS0dyQixFQUxILENBS00sVUFMTixFQUtrQnNCLFFBTGxCLEVBTUd0QixFQU5ILENBTU0saUJBTk4sRUFNeUJzQixRQU56QjtBQU9EIiwiZmlsZSI6InBhbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHBhbmFibGUgKHNwcml0ZSwgaW5lcnRpYSkge1xuXG4gIGZ1bmN0aW9uIG1vdXNlRG93biAoZSkge1xuICAgIHN0YXJ0KGUuZGF0YS5vcmlnaW5hbEV2ZW50KVxuICB9XG5cbiAgZnVuY3Rpb24gdG91Y2hTdGFydCAoZSkge1xuICAgIGlmIChlLmRhdGEub3JpZ2luYWxFdmVudC50YXJnZXRUb3VjaGVzICYmIGUuZGF0YS5vcmlnaW5hbEV2ZW50LnRhcmdldFRvdWNoZXNbMF0pIHtcbiAgICAgIHN0YXJ0KGUuZGF0YS5vcmlnaW5hbEV2ZW50LnRhcmdldFRvdWNoZXNbMF0pXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gc3RhcnQgKHQpIHtcbiAgICBpZiAoc3ByaXRlLl9wYW4pIHtcbiAgICAgIGlmICghc3ByaXRlLl9wYW4uaW50ZXJ2YWxJZCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNsZWFySW50ZXJ2YWwoc3ByaXRlLl9wYW4uaW50ZXJ2YWxJZClcbiAgICAgIHNwcml0ZS5lbWl0KCdwYW5lbmQnKVxuICAgIH1cbiAgICBzcHJpdGUuX3BhbiA9IHtcbiAgICAgIHA6IHtcbiAgICAgICAgeDogdC5jbGllbnRYLFxuICAgICAgICB5OiB0LmNsaWVudFksXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKClcbiAgICAgIH1cbiAgICB9XG4gICAgc3ByaXRlXG4gICAgICAub24oJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcbiAgICAgIC5vbigndG91Y2htb3ZlJywgdG91Y2hNb3ZlKVxuICB9XG5cbiAgZnVuY3Rpb24gbW91c2VNb3ZlIChlKSB7XG4gICAgbW92ZShlLCBlLmRhdGEub3JpZ2luYWxFdmVudClcbiAgfVxuXG4gIGZ1bmN0aW9uIHRvdWNoTW92ZSAoZSkge1xuICAgIGxldCB0ID0gZS5kYXRhLm9yaWdpbmFsRXZlbnQudGFyZ2V0VG91Y2hlc1xuICAgIGlmICghdCB8fCB0Lmxlbmd0aCA+IDEpIHtcbiAgICAgIGVuZChlLCB0WzBdKVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIG1vdmUoZSwgdFswXSlcbiAgfVxuXG4gIGZ1bmN0aW9uIG1vdmUgKGUsIHQpIHtcbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKVxuICAgIGxldCBpbnRlcnZhbCA9IG5vdyAtIHNwcml0ZS5fcGFuLnAuZGF0ZVxuICAgIGlmIChpbnRlcnZhbCA8IDEyKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgbGV0IGR4ID0gdC5jbGllbnRYIC0gc3ByaXRlLl9wYW4ucC54XG4gICAgbGV0IGR5ID0gdC5jbGllbnRZIC0gc3ByaXRlLl9wYW4ucC55XG4gICAgbGV0IGRpc3RhbmNlID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KVxuICAgIGlmICghc3ByaXRlLl9wYW4ucHApIHtcbiAgICAgIGxldCB0aHJlc2hvbGQgPSAodCBpbnN0YW5jZW9mIHdpbmRvdy5Nb3VzZUV2ZW50KSA/IDIgOiA3XG4gICAgICBpZiAoZGlzdGFuY2UgPiB0aHJlc2hvbGQpIHtcbiAgICAgICAgc3ByaXRlLmVtaXQoJ3BhbnN0YXJ0JylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZXZlbnQgPSB7XG4gICAgICAgIGRlbHRhWDogZHgsXG4gICAgICAgIGRlbHRhWTogZHksXG4gICAgICAgIHZlbG9jaXR5OiBkaXN0YW5jZSAvIGludGVydmFsLFxuICAgICAgICBkYXRhOiBlLmRhdGFcbiAgICAgIH1cbiAgICAgIHNwcml0ZS5lbWl0KCdwYW5tb3ZlJywgZXZlbnQpXG4gICAgfVxuICAgIHNwcml0ZS5fcGFuLnBwID0ge1xuICAgICAgeDogc3ByaXRlLl9wYW4ucC54LFxuICAgICAgeTogc3ByaXRlLl9wYW4ucC55LFxuICAgICAgZGF0ZTogc3ByaXRlLl9wYW4ucC5kYXRlXG4gICAgfVxuICAgIHNwcml0ZS5fcGFuLnAgPSB7XG4gICAgICB4OiB0LmNsaWVudFgsXG4gICAgICB5OiB0LmNsaWVudFksXG4gICAgICBkYXRlOiBub3dcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBtb3VzZVVwIChlKSB7XG4gICAgZW5kKGUsIGUuZGF0YS5vcmlnaW5hbEV2ZW50KVxuICB9XG5cbiAgZnVuY3Rpb24gdG91Y2hFbmQgKGUpIHtcbiAgICBlbmQoZSwgZS5kYXRhLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXMgJiYgZS5kYXRhLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0pXG4gIH1cblxuICBmdW5jdGlvbiBlbmQgKGUsIHQpIHtcbiAgICBzcHJpdGVcbiAgICAgIC5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgbW91c2VNb3ZlKVxuICAgICAgLnJlbW92ZUxpc3RlbmVyKCd0b3VjaG1vdmUnLCB0b3VjaE1vdmUpXG4gICAgaWYgKCFzcHJpdGUuX3BhbiB8fCAhc3ByaXRlLl9wYW4ucHApIHtcbiAgICAgIHNwcml0ZS5fcGFuID0gbnVsbFxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGlmIChpbmVydGlhICYmIHQpIHtcbiAgICAgIGlmIChzcHJpdGUuX3Bhbi5pbnRlcnZhbElkKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgbGV0IGludGVydmFsID0gbmV3IERhdGUoKSAtIHNwcml0ZS5fcGFuLnBwLmRhdGVcbiAgICAgIGxldCB2eCA9ICh0LmNsaWVudFggLSBzcHJpdGUuX3Bhbi5wcC54KSAvIGludGVydmFsXG4gICAgICBsZXQgdnkgPSAodC5jbGllbnRZIC0gc3ByaXRlLl9wYW4ucHAueSkgLyBpbnRlcnZhbFxuICAgICAgc3ByaXRlLl9wYW4uaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgaWYgKE1hdGguYWJzKHZ4KSA8IDAuMDQgJiYgTWF0aC5hYnModnkpIDwgMC4wNCkge1xuICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc3ByaXRlLl9wYW4uaW50ZXJ2YWxJZClcbiAgICAgICAgICBzcHJpdGUuZW1pdCgncGFuZW5kJylcbiAgICAgICAgICBzcHJpdGUuX3BhbiA9IG51bGxcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICBsZXQgdG91Y2ggPSB7XG4gICAgICAgICAgY2xpZW50WDogc3ByaXRlLl9wYW4ucC54ICsgdnggKiAxMixcbiAgICAgICAgICBjbGllbnRZOiBzcHJpdGUuX3Bhbi5wLnkgKyB2eSAqIDEyXG4gICAgICAgIH1cbiAgICAgICAgbW92ZShlLCB0b3VjaClcbiAgICAgICAgdnggKj0gMC45XG4gICAgICAgIHZ5ICo9IDAuOVxuICAgICAgfSwgMTIpXG4gICAgfSBlbHNlIHtcbiAgICAgIHNwcml0ZS5lbWl0KCdwYW5lbmQnKVxuICAgICAgc3ByaXRlLl9wYW4gPSBudWxsXG4gICAgfVxuICB9XG5cbiAgc3ByaXRlLmludGVyYWN0aXZlID0gdHJ1ZVxuICBzcHJpdGVcbiAgICAub24oJ21vdXNlZG93bicsIG1vdXNlRG93bilcbiAgICAub24oJ3RvdWNoc3RhcnQnLCB0b3VjaFN0YXJ0KVxuICAgIC5vbignbW91c2V1cCcsIG1vdXNlVXApXG4gICAgLm9uKCdtb3VzZXVwb3V0c2lkZScsIG1vdXNlVXApXG4gICAgLm9uKCd0b3VjaGVuZCcsIHRvdWNoRW5kKVxuICAgIC5vbigndG91Y2hlbmRvdXRzaWRlJywgdG91Y2hFbmQpXG59XG4iXX0=